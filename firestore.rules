/**
 * Core Philosophy: This ruleset enforces a strict user-ownership model. Each user has exclusive control over their
 * own data, including their profile and session history. There are no public or shared collections.
 *
 * Data Structure: The data is organized hierarchically. All user-specific information, such as session logs, is
 * stored in subcollections under that user's primary document. The structure is `/users/{userId}/...`.
 *
 * Key Security Decisions:
 * - User Isolation: Access is strictly limited by the `userId` in the path. A user can never read or write data
 *   belonging to another user.
 * - No User Enumeration: Listing the top-level `/users` collection is explicitly disallowed to prevent malicious
 *   actors from discovering all user IDs in the system.
 * - Path-Based Security: Authorization relies entirely on the document path (`/users/{userId}`), which is fast,
 *   performant, and avoids costly `get()` calls to other documents for permission checks.
 *
 * Denormalization for Authorization: The `userId` from the authentication token is compared directly against the
 * `userId` in the document path. For documents within subcollections (e.g., sessions), we also validate that an
 * internal `userId` field is present and matches the path, ensuring relational integrity without extra reads.
 *
 * Structural Segregation: All private user data is naturally segregated by being placed in subcollections under
 * the `/users/{userId}` path, which is the most secure and scalable pattern for user-owned data.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ----------------------------------------------------------------------
    // Helper Functions
    // ----------------------------------------------------------------------

    /**
     * Checks if a user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the currently authenticated user's UID matches the provided userId.
     * This is the fundamental check for data ownership.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * A robust check for update/delete operations, ensuring the user is the owner
     * AND the document they are trying to modify actually exists.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * Validates a new User document on create.
     * Ensures the creator is the owner and the internal 'id' field matches the document's path ID.
     */
    function isNewUserDocumentValid(userId) {
      return isOwner(userId) && request.resource.data.id == userId;
    }

    /**
     * Validates a User document on update.
     * Ensures the user is the owner and that the critical 'id' field is not being changed.
     */
    function isUserDocumentUpdateValid(userId) {
      return isExistingOwner(userId) && request.resource.data.id == resource.data.id;
    }

    /**
     * Validates a new Session document on create.
     * Ensures the creator is the owner of the parent user document and the internal 'userId' field
     * correctly references the parent user.
     */
    function isNewSessionDocumentValid(userId) {
      return isOwner(userId) && request.resource.data.userId == userId;
    }

    /**
     * Validates a Session document on update.
     * Ensures the user is the owner and that the 'userId' foreign key is not being changed.
     */
    function isSessionDocumentUpdateValid(userId) {
      return isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
    }


    // ----------------------------------------------------------------------
    // Collection Rules
    // ----------------------------------------------------------------------

    /**
     * @description Controls access to a user's own profile document.
     * @path /users/{userId}
     * @allow A user (auth.uid: 'user123') can (create) or (get) their own profile at `/users/user123`.
     * @deny A user (auth.uid: 'user456') cannot (get) or (update) a document at `/users/user123`.
     * @deny Any user, signed-in or not, cannot (list) the entire `/users` collection.
     * @principle Restricts access to a user's own data tree and prevents user enumeration.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false; // CRITICAL: Prevents listing all users in the database.
      allow create: if isNewUserDocumentValid(userId);
      allow update: if isUserDocumentUpdateValid(userId);
      allow delete: if isExistingOwner(userId);

      /**
       * @description Controls access to a user's session history.
       * @path /users/{userId}/sessions/{sessionId}
       * @allow A user (auth.uid: 'user123') can (create) and (list) their own sessions under `/users/user123/sessions`.
       * @deny A user (auth.uid: 'user456') cannot (get) or (delete) a session at `/users/user123/sessions/abc`.
       * @principle Enforces path-based ownership for subcollections, ensuring sessions remain private to the user.
       */
      match /sessions/{sessionId} {
        allow get: if isOwner(userId);
        allow list: if isOwner(userId);
        allow create: if isNewSessionDocumentValid(userId);
        allow update: if isSessionDocumentUpdateValid(userId);
        allow delete: if isExistingOwner(userId);
      }
    }
  }
}